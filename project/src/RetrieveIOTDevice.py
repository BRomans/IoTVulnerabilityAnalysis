#!/usr/bin/env python

import fileinput
import shodan
import json
import time


def elabJSON(jsonObj, parsed_json):
    new_json_obj = {}

    timestamp = time.time()
    new_json_obj["search_timestamp"] = timestamp
    new_json_obj["create_timestamp"] = parsed_json["timestamp"]
    filename = parsed_json["ip_str"].replace('.', '')
    filename = filename.replace(':', '')
    new_json_obj["filename"] = filename

    new_json_obj["ip_str"] = jsonObj["ip_str"]
    new_json_obj["type"] = parsed_json["type"]
    new_json_obj["postal_code"] = jsonObj["postal_code"]
    new_json_obj["country_code"] = jsonObj["country_code"]
    new_json_obj["country_name"] = jsonObj["country_name"]
    new_json_obj["city"] = jsonObj["city"]

    new_json_obj["coordinates"] = {}
    new_json_obj["coordinates"]["lat"] = jsonObj["latitude"]
    new_json_obj["coordinates"]["lon"] = jsonObj["longitude"]

    new_json_obj["ports"] = jsonObj["ports"]

    if 'vulns' in jsonObj:
        new_json_obj["vulns"] = jsonObj["vulns"]

    new_json_obj['data'] = []
    new_json_obj["size_data"] = 0
    for data in jsonObj['data']:
        new_json_obj["size_data"] += 1
        temp = {}
        if 'title' in data:
            temp["title"] = data["title"]

        if 'transport' in data:
            temp["transport"] = data["transport"]

        if 'port' in data:
            temp["port"] = data["port"]

        if 'location' in data:
            temp["location"] = data["location"]

        if 'http' in data:
            temp["http"] = data["http"]["server"]

        if 'os' in data:
            temp["os"] = data["os"]

        if 'ftp' in data:
            temp["ftp"] = data["ftp"]["features"]

        if 'ssl' in data:
            temp["ssl"] = data["ssl"]["versions"]

        if 'version' in data:
            temp["version"] = data["version"]

        if 'product' in data:
            temp["product"] = data["product"]

        if '_shodan' in data:
            temp["shodan"] = {}
            temp["shodan"]["module"] = data["_shodan"]["module"]
            temp[data["_shodan"]["module"]] = True

        if 'ssh' in data:
            temp["ssh"] = data["ssh"]

        new_json_obj['data'].append(temp)

    return new_json_obj


# Wrap the request in a try/ except block to catch errors
try:
    for json_data in fileinput.input():
        parsedJson = json.loads(json_data)
        # print("Details IOT device with address: " + parsed_json['ip_str'])

        api = shodan.Shodan(parsedJson['SHODAN_API_KEY'])

        jsonObject = api.host(parsedJson['ip_str'])

        newJsonObj = elabJSON(jsonObject, parsedJson)

        print(json.dumps(newJsonObj))

except Exception as e:
    print('Error: {}'.format(e))
